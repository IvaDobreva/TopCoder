<apex:component >
<script type="text/javascript">
copyFields=function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};var UserViewModel=function(){function n(n){n&&jQuery.extend(this,n)}return Object.defineProperty(n.prototype,"fullName",{get:function(){return((this.firstName||"")+" "+(this.lastName||"")).trim()},enumerable:!0,configurable:!0}),n}(),Activity=function(){function n(n){var r,t,i,u;if(this.title="",this.description="",this.challengeType="Assigned",this.phase="",this.codeTypes=[],this.noPrizes=!1,this.requirements=[],this.prizes=[new ActivityPrize],this.documents=[],this.registrationsCount=0,this.submissionsCount=0,n&&(this.id=n.id,this.title=n.title,this.challengeType=n.challengeType,this.codeTypes=n.codeTypes.length?n.codeTypes.map(function(n){return new CodeType(n.name,n.skillId,n.id)}):undefined,this.milestones=n.milestones.map(function(n){return new ActivityMilestone(n)}),this.noPrizes=n.noPrizes,this.requirements=n.requirements.map(function(n){return new ActivityRequirement(n)}),this.prizes=n.prizes.map(function(n){return new ActivityPrize(n)}),this.story=n.story,this.documents=n.documents,this.description=jQuery("<div/>").html(n.description).text(),this.phase=n.phase,this.registrationsCount=n.registrationsCount,this.submissionsCount=n.submissionsCount,this.isRegistered=n.isRegistered,n.assignedMember&&(this.assignedMember=new UserViewModel(n.assignedMember))),!this.milestones||!this.milestones.length)for(r=moment(),this.milestones=[],t=0;t<GLOBAL_CONFIG.milestones.length;t++)i=new ActivityMilestone(GLOBAL_CONFIG.milestones[t]),u=t==0?0:GLOBAL_CONFIG.milestones[t-1].defaultDuration,i.scheduledDate=r.add(u,"days").clone().toDate(),this.milestones.push(i)}return n.prototype.getModel=function(){return{id:this.id,title:this.title,description:this.description,challengeType:this.challengeType,phase:this.phase,codeTypes:this.codeTypes?this.codeTypes.map(function(n){return new CodeType(n.name,n.skillId,n.id)}):[],milestones:this.milestones.map(function(n){return n.getModel()}),isRegistered:this.isRegistered,noPrizes:this.noPrizes,requirements:this.requirements.map(function(n){return n.getModel()}),prizes:this.noPrizes?[]:this.prizes.map(function(n){return n.getModel()})}},n}(),Story=function(){function n(n){this.title="";this.description="";this.serviceOffering=null;this.phase="";this.activities=[];n&&(this.activities=n.activities,this.title=n.title,this.description=jQuery("<div/>").html(n.description).text(),this.serviceOffering=n.serviceOffering,this.id=n.id,this.phase=n.phase,this.publisher=new UserViewModel(n.publisher))}return n.prototype.getModel=function(){return{id:this.id,title:this.title,description:this.description,serviceOffering:this.serviceOffering,status:this.phase,activities:this.activities.map(function(n){return n.getModel()})}},n}(),CodeType=function(){function n(n,t,i){this.name=n;this.id=t;this.skillId=i}return n}(),ActivityDocument=function(){function n(){}return n}(),ActivityMilestone=function(){function n(n){n&&(this.scheduledDate=n.scheduledDate?moment.utc(n.scheduledDate).toDate():null,this.completedDate=n.completedDate?moment.utc(n.completedDate).toDate():null,this.name=n.name)}return n.prototype.getOffset=function(n){return n?moment.duration(moment(this.scheduledDate).diff(moment(n.scheduledDate))).asDays():0},n.prototype.getModel=function(){var n=moment(this.scheduledDate),t=moment(this.completedDate);return{name:this.name,scheduledDate:this.scheduledDate?n.subtract(n.zone(),"minutes").toDate().toUTCString():undefined,completedDate:this.completedDate?t.subtract(t.zone(),"minutes").toDate().toUTCString():undefined}},n}(),ActivityPrize=function(){function n(n){this.place=1;this.amount=0;n&&(this.id=n.id,this.place=n.place,this.amount=n.amount)}return Object.defineProperty(n.prototype,"placeLabel",{get:function(){var n="";switch(this.place){case 1:n="st";break;case 2:n="nd";break;case 3:n="rd";break;default:n="th"}return this.place+n},enumerable:!0,configurable:!0}),n.prototype.getModel=function(){return{id:this.id,place:this.place,amount:this.amount}},n}(),ActivityRecomendedMembersViewModel=function(){function n(n,t){this.isInitialized=!1;this.recomendedUsers=[];this._selectAll=!1;this.activityId=n;t&&(this.service=t.service,this.dialogs=t.dialogs)}return Object.defineProperty(n.prototype,"selectAll",{get:function(){return this._selectAll},set:function(n){var t=this;this._selectAll=n;this.recomendedUsers.map(function(n){return n.selected=t._selectAll})},enumerable:!0,configurable:!0}),n.prototype.initialize=function(){var n=this;this.isInitialized||(this.isInitialized=!0,this.service.getRecommendedMembers(this.activityId).then(function(t){n.recomendedUsers=t},function(){n.isInitialized=!1}))},n.prototype.emailSelected=function(){var n=[];this.recomendedUsers.map(function(t){t.selected&&n.push(t.id)});this.emailMembers(n)},n.prototype.emailMember=function(n){this.emailMembers([n])},n.prototype.emailMembers=function(n){this.service.emailToMember(n).then(function(){},function(){})},n}(),ActivityRegistrantsViewModel=function(){function n(n,t){this.isInitialized=!1;this.registrants=[];this.page=1;this.pageSize=8;this.activityId=n;t&&(this.service=t.service,this.dialogs=t.dialogs)}return n.prototype.emailMember=function(n){this.service.emailToMember([n]).then(function(){},function(){})},n.prototype.pageChanged=function(){this.fetchRegistrants()},n.prototype.initialize=function(){this.isInitialized||(this.isInitialized=!0,this.fetchRegistrants())},n.prototype.fetchRegistrants=function(){var n=this;this.service.getRegistrants(this.activityId,this.page,this.pageSize).then(function(t){n.registrants=t},function(){})},n}(),ActivityRegistration=function(){function n(n){this.user=new UserViewModel;n&&(this.id=n.id,this.registrationDate=n.registrationDate,this.user=new UserViewModel(n.user))}return n}(),ActivityRequirement=function(){function n(t){this.childRequirements=[];this.requirementType="";this.importance="";this.description="";t&&(this.description=jQuery("<div/>").html(t.description).text(),this.id=t.id,this.requirementType=t.type,this.importance=t.importance,this.requirementNumber=t.requirementNumber,this.childRequirements=t.childRequirements.map(function(t){return new n(t)}))}return n.prototype.getModel=function(){return{id:this.id,requirementNumber:this.requirementNumber,type:this.requirementType,importance:this.importance,childRequirements:this.childRequirements.map(function(n){return n.getModel()}),description:this.description}},n}(),__extends=this&&this.__extends||function(n,t){function r(){this.constructor=n}for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);r.prototype=t.prototype;n.prototype=new r},ActivityRequirementViewModel=function(n){function t(){n.apply(this,arguments)}return __extends(t,n),t.prototype.addRequirement=function(){var n=new t;n.requirementNumber=this.requirementNumber.split(".")[0]+"."+(this.childRequirements.length+1);this.childRequirements.push(n)},t.prototype.removeRequirement=function(n){this.childRequirements.splice(n,1);var t=this.requirementNumber.split(".")[0];this.childRequirements.map(function(n,i){return n.requirementNumber=t+"."+(i+1)})},t}(ActivityRequirement),ActivitySubmission=function(){function n(n){this.user=new UserViewModel;n&&(this.id=n.id,this.submissionnDate=n.submissionnDate,this.user=new UserViewModel(n.user))}return n}(),__extends=this&&this.__extends||function(n,t){function r(){this.constructor=n}for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);r.prototype=t.prototype;n.prototype=new r},ActivityViewModel=function(n){function t(t,i){n.call(this,t);this.isActive=!1;this.activeTab=0;this.startOffset=0;this.fileToUpload={file:null,description:"",fileName:""};this.defaultSkills=[];t&&(delete this.requirements,this.requirements=t.requirements.map(function(n){return new ActivityRequirementViewModel(n)}));i&&(this.service=i.service,this.dialogs=i.dialogs,this.navigation=i.navigation,this.registrants=new ActivityRegistrantsViewModel(this.id,i),this.recomendations=new ActivityRecomendedMembersViewModel(this.id,i),this.registrants.totalRegistrants=this.registrationsCount,this.service&&t&&(this.chatterUrl=this.service.trustAsResourceUrl(GLOBAL_CONFIG.activityChatterUrl+"?id="+this.id)))}return __extends(t,n),t.prototype.milestoneDuration=function(n){if(n===this.milestones.length-1)return 0;var t=0;return t=moment(this.milestones[n+1].scheduledDate).diff(moment(this.milestones[n].scheduledDate)),moment.duration(t).asDays()},t.prototype.milestoneChanged=function(n,t,i){var u=moment.duration(moment(t).diff(moment(i))).asDays(),r,f;if(u>0)for(r=n+1;r<this.milestones.length;r++)f=moment(this.milestones[r].scheduledDate).add(u,"days"),this.milestones[r].scheduledDate=f.toDate()},t.prototype.removeRequirement=function(n){this.requirements.splice(n,1);this.requirements.map(function(n,t){n.requirementNumber=t+1+".0";n.childRequirements.map(function(n,i){return n.requirementNumber=t+1+"."+(i+1)})})},t.prototype.selectTab=function(n){this.activeTab=n;switch(n){case 1:this.registrants.initialize();this.fetchAssignedMember();break;case 2:this.recomendations.initialize()}},t.prototype.registerToActivity=function(){var n=this;this.dialogs.showRegistrationConfirm().result.then(function(t){t&&n.service.registerToActivity(n.id).then(function(){n.isRegistered=!0},function(){})})},t.prototype.setDefaultCodeTypes=function(n){var r=this,u=this.codeTypes,t,i;this.codeTypes=[];t=[];i=[];_.map(n,function(n){var r=_.extend(new CodeType(n.name,n.skillId,n.id),_.findWhere(u,{id:n.skillId}));return delete r.$$hashKey,i.push(r),r.skillId&&t.push(r),r});this.defaultSkills=i;setTimeout(function(){r.codeTypes=t},500)},t.prototype.addRequirement=function(){var n=new ActivityRequirementViewModel;n.requirementNumber=this.requirements.length+1+".0";this.requirements.push(n)},t.prototype.addPrize=function(){if(!this.noPrizes){var n=new ActivityPrize;n.place=this.prizes.length+1;this.prizes.push(n)}},t.prototype.removePrize=function(n){if(!this.noPrizes){this.prizes.splice(n,1);for(var t=this.prizes.length;t>0;t--)this.prizes[t-1].place=t}},Object.defineProperty(t.prototype,"activityDuration",{get:function(){return this.milestones[this.milestones.length-1].getOffset(this.milestones[0])},enumerable:!0,configurable:!0}),t.prototype.uploadFile=function(){var i=this,t=this.dialogs.showLoading(),n;this.fileToUpload.file&&(n={description:this.fileToUpload.description,name:this.fileToUpload.fileName,body:this.fileToUpload.file.substring(this.fileToUpload.file.indexOf("base64")+7),parentId:this.id},delete this.fileToUpload,this.fileToUpload={},this.service.uploadAttachment(n).then(function(r){if(t.close(),r[0].success){var u=new ActivityDocument;u.id=r[0].id;u.description=n.description;u.name=n.name;u.createdDate=new Date;i.documents.push(u)}},function(){t.close()},function(){t.close()}))},t.prototype.addFile=function(n){this.fileToUpload.file=n.files.length?n.files[0]:null},t.prototype.deleteDocument=function(n){var t=this,i;n<0||n>=this.documents.length||(i=this.documents[n],i&&this.dialogs.showRegistrationConfirm().result.then(function(r){if(r){var u=t.dialogs.showLoading();t.service.deleteDocument(i.id).then(function(){t.documents.splice(n,1);u.close()},function(){u.close()})}}))},t.prototype.assignMember=function(n){var t=this;this.dialogs.showAssignMember(this.title,n.user.firstName+" "+n.user.lastName).result.then(function(i){i&&t.service.assignMember(t.id,n.user.id).then(function(){t.assignedMember=n.user;t.assignedMemberRegistration=n},function(){})})},t.prototype.unassignMember=function(){var n=this;this.service.unassignMember(this.id).then(function(){n.assignedMember=null},function(){})},t.prototype.saveAsDraft=function(){this.phase="Draft";this.upsert()},t.prototype.publish=function(){var n=this;this.upsert(function(){n.navigation&&n.navigation.path("/publisherActivityDetailsAssignRegister/"+n.id)})},t.prototype.upsert=function(n){var i=this,t;n===void 0&&(n=null);t=this.phase==="Draft"?this.dialogs.showSavingDraftActivity():this.dialogs.showLoading();this.id?this.service.upsertActivity(this.getModel()).then(function(){t.close();n&&n()},function(){t.close()}):this.service.createActivity({title:this.title,description:this.description,challengeType:this.challengeType,storyId:this.story.id,phase:this.phase}).then(function(n){i.id=n.id;t.close()},function(){t.close()})},t.prototype.cancelActivity=function(){var n=this;this.dialogs.showCancelActivity(this.title).result.then(function(t){if(t){var i=n.dialogs.showLoading();n.service.cancelActivity(n.id).then(function(){n.phase="Canceled";i.close()},function(){i.close()})}})},t.prototype.completeActivity=function(){var t=this,n=this.dialogs.showLoading();this.service.completeActivity(this.id).then(function(){t.phase="Completed";n.close();window.location=window.location},function(){n.close()})},t.prototype.clone=function(){return new t(angular.fromJson(angular.toJson(this)))},t.prototype.fetchAssignedMember=function(){var n=this;this.service.getAssignedMember(this.id).then(function(t){n.assignedMemberRegistration=new ActivityRegistration(t)},function(){})},t}(Activity),__extends=this&&this.__extends||function(n,t){function r(){this.constructor=n}for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);r.prototype=t.prototype;n.prototype=new r},StoryViewModel=function(n){function t(t,i){var u,r;for(n.call(this,t),this.isActive=!0,i&&(this.service=i.service,this.dialogs=i.dialogs),u=this.activities||[],this.activities=[],r=0;r<u.length;r++)this.activities.push(new ActivityViewModel(u[r],i))}return __extends(t,n),t.prototype.addActivity=function(n){if(n!==undefined){if(n>=0&&n<this.activities.length){var t=this.activities[n];this.activities.push(t.clone())}}else this.activities.push(new ActivityViewModel)},t.prototype.removeActivity=function(n){var r=this,t,i;n!==undefined&&n>=0&&n<this.activities.length&&(t=this.activities[n].id,t?(i=this.dialogs.showLoading(),this.service.deleteActivity(t).then(function(){r.activities.splice(n,1);i.close()},function(){i.close()})):this.activities.splice(n,1))},t.prototype.setActiveTab=function(n){if(!(n<-1)&&!(n>=this.activities.length)){this.isActive=!1;for(var t=0;t<this.activities.length;t++)this.activities[t].isActive=!1;n<0?this.isActive=!0:this.activities[n].isActive=!0}},t.prototype.setStartOffsets=function(){var t,i,r,u,n;if(this.activities&&this.activities.length){for(t=moment(this.activities[0].milestones[0].scheduledDate),i=moment(this.activities[0].milestones[this.activities[0].milestones.length-1].scheduledDate),n=1;n<this.activities.length;n++)r=moment(this.activities[n].milestones[0].scheduledDate),u=moment(this.activities[n].milestones[this.activities[n].milestones.length-1].scheduledDate),r.diff(t)<0&&(t=r),u.diff(i)>0&&(i=u);for(this.storyStart=t.toDate(),this.storyEnd=i.toDate(),n=1;n<this.activities.length;n++)this.activities[n].startOffset=moment.duration(moment(this.activities[n].milestones[0].scheduledDate).diff(t)).asDays()}},Object.defineProperty(t.prototype,"storyDuration",{get:function(){this.setStartOffsets();var n=moment(this.storyEnd).diff(moment(this.storyStart)),t=moment.duration(n);return t.asDays()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"totalBudget",{get:function(){for(var n,t,r=0,i=0;i<this.activities.length;i++)if((n=this.activities[i],!n.noPrizes)&&n.prizes)for(t=0;t<n.prizes.length;t++)r+=n.prizes[t].amount;return r},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"registrationsCount",{get:function(){var n=0;return this.activities.map(function(t){return n+=t.registrationsCount}),n},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"submissionsCount",{get:function(){var n=0;return this.activities.map(function(t){return n+=t.submissionsCount}),n},enumerable:!0,configurable:!0}),t}(Story),StoriesFilterViewModel=function(){function n(){this.storyTitle="";this.activityTitle="";this.serviceOffering="";this.activityPhase="";this.showOnlyCompleted=!1;this.isActive=!1;this.clear()}return n.prototype.clear=function(){this.storyTitle="";this.activityTitle="";this.serviceOffering="";this.activityPhase=""},n.prototype.getModel=function(){var n=jQuery.extend(!1,{},this);return delete n.isActive,n.serviceOffering==="all"&&delete n.serviceOffering,n.activityPhase==="all"&&delete n.activityPhase,n},n}(),CreateStoryViewModel=function(){function n(n){this.step=1;this.story=new StoryViewModel(null,n);this.story.activities.push(new ActivityViewModel(null,n));this.stepsCount=this.story.activities.length+2;this.service=n.service;this.dialogs=n.dialogs}return n.prototype.goToNext=function(){this.step!==this.story.activities.length+2&&this.saveCurrentStep(!0)},n.prototype.publish=function(){this.story.phase="In Progress";this.saveCurrentStep(!0,function(){return window.location=document.location.href.match(/(^[^#]*)/)[0]})},n.prototype.saveCurrentStep=function(n,t){var u=this,i,r;n===void 0&&(n=!1);i=this.dialogs.showLoading();this.step===1||this.step===this.story.activities.length+2?this.service.upsertStory({id:this.story.id,title:this.story.title,description:this.story.description,serviceOffering:this.story.serviceOffering}).then(function(r){u.story.id=r.id;n&&(u.step=u.step+1);t&&t();i.close()},function(){i.close()}):(r=this.story.activities[this.step-2],r.id?this.service.upsertActivity(r.getModel()).then(function(){n&&(u.step=u.step+1);i.close()},function(){i.close()}):this.service.createActivity({title:r.title,description:r.description,challengeType:r.challengeType,storyId:this.story.id}).then(function(n){r.id=n.id;i.close()},function(){i.close()}))},n.prototype.removeActivity=function(n){var t=this;this.dialogs.showRegistrationConfirm().result.then(function(){t.story.removeActivity(n);n===t.step+1&&(t.step=t.step-1)})},n.prototype.goToPrev=function(){this.step!==1&&(this.step=this.step-1)},n.prototype.goToStep=function(n){this.step<2||n<1||n>this.story.activities.length+2||(this.step=n)},n}(),StoriesListViewModel=function(){function n(n,t){n===void 0&&(n=new StoriesFilterViewModel);t===void 0&&(t=!1);this.stories=[];this.pageSize=5;this.page=1;this.totalPages=1;this.totalItems=0;this.isActive=!0;this.fetchOnlyCompleted=!1;this.isLoading=!1;this.filter=n;this.fetchOnlyCompleted=t}return n.prototype.fetchStories=function(n){var t=this;(n===void 0&&(n=!1),this.filter||(this.filter=new StoriesFilterViewModel),this.filter.showOnlyCompleted=this.fetchOnlyCompleted,this.isLoading)||(this.isLoading=!0,n&&(this.page=1,this.totalItems=0,this.totalPages=1,this.stories=[]),this.service!=null&&this.service.getStories!=null?this.service.getStories({page:this.page,pageSize:this.pageSize,filter:this.filter.getModel()}).then(function(n){t.totalItems=n.totalItems;t.totalPages=n.totalPages;t.stories=n.stories.map(function(n){return new StoryViewModel(n)});t.isLoading=!1},function(){t.isLoading=!1}):this.isLoading=!1)},n.prototype.pageChanged=function(){this.fetchStories()},n.prototype.goToPage=function(){this.page!==1&&this.page!==this.totalPages&&(this.fetchStories(),this.fetchStories())},n}(),StoriesViewModel=function(){function n(n){this.filter=new StoriesFilterViewModel;this.activeStories=new StoriesListViewModel(this.filter);this.activeStories.service=n;this.activeStories.fetchStories();this.activeStories.isActive=!0;this.completedStories=new StoriesListViewModel(this.filter,!0);this.completedStories.service=n;this.filter.showOnlyCompleted=!0;this.completedStories.fetchStories();this.showTab(1)}return n.prototype.resetFilter=function(){this.filter.clear();this.filter.isActive=!1;this.activeStories.fetchStories();this.completedStories.fetchStories()},n.prototype.filterStories=function(){this.activeStories.fetchStories(!0);this.completedStories.fetchStories(!0)},n.prototype.showTab=function(n){this.activeStories.isActive=n===1;this.completedStories.isActive=n===2},n}(),__extends=this&&this.__extends||function(n,t){function r(){this.constructor=n}for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);r.prototype=t.prototype;n.prototype=new r},StoryDetailsViewModel=function(n){function t(t){n.call(this,{id:t.id});this.service=t.service;this.dialogs=t.dialogs;this.refresh()}return __extends(t,n),t.prototype.refresh=function(){var n=this;this.service.getStory(this.id,!0).then(function(t){jQuery.extend(!0,n,new StoryViewModel(t))},function(){})},t.prototype.registerToActivity=function(n){var t=this;n&&this.dialogs.showRegistrationConfirm().result.then(function(i){i&&t.service.registerToActivity(n).then(function(){for(var r,i=0;i<t.activities.length;i++)if(r=t.activities[i],r.id===n){r.isRegistered=!0;break}},function(){})})},t}(StoryViewModel),__extends=this&&this.__extends||function(n,t){function r(){this.constructor=n}for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);r.prototype=t.prototype;n.prototype=new r},StoryPublisherDetailsViewModel=function(n){function t(t){n.call(this,{id:t.id});this.isEditMode=!1;this.service=t.service;this.dialogs=t.dialogs;this.refresh();this.isActive=!0}return __extends(t,n),Object.defineProperty(t.prototype,"daysPassed",{get:function(){return moment.duration(moment().diff(moment(this.storyStart))).asDays()},enumerable:!0,configurable:!0}),t.prototype.refresh=function(){var n=this;this.service.getStory(this.id,!0).then(function(t){var i=new StoryViewModel(t,{service:n.service,dialogs:n.dialogs});i.setStartOffsets();n.service&&i.activities.map(function(t){t.chatterUrl=n.service.trustAsResourceUrl(GLOBAL_CONFIG.activityChatterUrl+"?id="+t.id)});copyFields(n,i)},function(){})},t.prototype.updateStory=function(){var n=this;this.service.upsertStory({id:this.id,title:this.title,description:this.description,serviceOffering:this.serviceOffering}).then(function(){n.isEditMode=!1},function(){})},t.prototype.editStory=function(){this.isEditMode=!0},t.prototype.cancelEditMode=function(){this.isEditMode=!1},t.prototype.closeStory=function(){var n=this;this.dialogs.showRegistrationConfirm().result.then(function(t){t&&n.service.cancelStory(n.id).then(function(){window.location=window.location},function(){})})},t.prototype.setActiveTab=function(n){n>=0&&n<=this.activities.length&&(this.isActive=!1,this.activities.map(function(n){return n.isActive=!1}),n===0?this.isActive=!0:(this.isEditMode=!1,this.activities[n-1].isActive=!0))},t}(StoryViewModel)

</script>
</apex:component>